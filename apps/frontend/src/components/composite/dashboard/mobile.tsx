import { useActions } from "@/components/providers/actions-provider";
import { useEvents } from "@/components/providers/events-provider";
import { useMatchState } from "@/components/providers/match-state-provider";
import { mockMatchTimeline } from "@/mock/match-timeline";
import type { MatchTimeline } from "@/types";
import { memo, useMemo, useState } from "react";
import ConnectionStatus from "../connection-status";
import EventsFeed from "../events-feed";
import MatchInfoInline from "../match-info";
import { MobileSettingsModal } from "../mobile-settings-modal";
import { ModeToggle } from "../mode-toggle";
import { PollDialog } from "../poll-dialog";
import { PollFAB } from "../poll-fab";
import { ScrollToTop } from "../scroll-to-top";
import ShareSimulationButton from "../share-simulation-button";
import { SimulationFAB } from "../simulation-fab";
import TeamCard from "../team-card";
import ViewerModeBanner from "../viewer-mode-banner";

const MobileView = memo(function MobileView() {
  const [isPollOpen, setIsPollOpen] = useState(false);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);

  const { matchState, isSimulationRunning } = useMatchState();
  const { events, poll, hasVoted, userVote } = useEvents();
  const {
    isOwner,
    startSimulation,
    pauseSimulation,
    resumeSimulation,
    resetSimulation,
    votePoll,
  } = useActions();

  // Get team names from match state or use mock data
  const teamA = matchState?.teamA || mockMatchTimeline.teamA;
  const teamB = matchState?.teamB || mockMatchTimeline.teamB;
  const scoreA = matchState?.scoreA || 0;
  const scoreB = matchState?.scoreB || 0;

  // Memoize logo URLs to prevent TeamCard rerenders
  const teamALogo = useMemo(
    () => `https://api.dicebear.com/7.x/identicon/svg?seed=${teamA}`,
    [teamA]
  );

  const teamBLogo = useMemo(
    () => `https://api.dicebear.com/7.x/identicon/svg?seed=${teamB}`,
    [teamB]
  );

  const handlePlayPause = () => {
    if (!isOwner) return;

    if (isSimulationRunning) {
      // Pause if currently running
      pauseSimulation();
    } else if (matchState) {
      // Resume if paused (matchState exists)
      resumeSimulation();
    } else {
      // Start new simulation (no matchState = fresh start)
      startSimulation(teamA, teamB);
    }
  };

  const handleReset = () => {
    if (!isOwner) return;
    resetSimulation();
  };

  const handleSettings = () => {
    setIsSettingsOpen(true);
  };

  const handleSaveSettings = (timeline: MatchTimeline) => {
    console.log("Saving timeline:", timeline);
    if (isOwner) {
      startSimulation(timeline.teamA, timeline.teamB);
    }
    setIsSettingsOpen(false);
  };

  const handlePoll = () => {
    setIsPollOpen(true);
  };

  const handleVote = (optionId: string) => {
    votePoll(optionId);
  };

  return (
    <>
      <ViewerModeBanner />
      <header className="flex justify-between items-center p-4 bg-white dark:bg-slate-950 rounded-lg">
        <div className="flex flex-col gap-2">
          <h1 className="text-xl sm:text-2xl font-bold">Match Simulation</h1>
          <div className="flex items-center gap-2">
            <ConnectionStatus showText={false} />
            <MatchInfoInline />
          </div>
        </div>
        <div className="flex items-center gap-2 self-start">
          <ShareSimulationButton size="sm" />
          <ModeToggle />
        </div>
      </header>

      <section id="dashboard-mobile">
        <section
          id="teams-mobile"
          className="grid grid-cols-2 gap-4 sticky top-0 z-10 bg-white dark:bg-slate-950 py-4"
        >
          <section id="team-a-mobile">
            <TeamCard
              teamName={teamA}
              teamScore={scoreA}
              teamLogo={teamALogo}
            />
          </section>
          <section id="team-b-mobile">
            <TeamCard
              teamName={teamB}
              teamScore={scoreB}
              teamLogo={teamBLogo}
            />
          </section>
        </section>
        <section id="commentary-mobile" className="z-1">
          <EventsFeed
            events={events}
            className="flex-1 h-auto"
            hideScrollIndicators
          />
        </section>
      </section>

      {/* Floating Action Buttons */}
      <SimulationFAB
        isPlaying={isSimulationRunning}
        onPlayPause={handlePlayPause}
        onReset={handleReset}
        onSettings={handleSettings}
        disabled={!isOwner}
      />

      {poll && <PollFAB onClick={handlePoll} />}

      {/* Scroll to Top Button */}
      <ScrollToTop threshold={200} />

      {/* Poll Dialog */}
      {poll && (
        <PollDialog
          isOpen={isPollOpen}
          onClose={() => setIsPollOpen(false)}
          poll={poll}
          onVote={handleVote}
          hasVoted={hasVoted}
          userVote={userVote || undefined}
        />
      )}

      {/* Settings Modal */}
      <MobileSettingsModal
        isOpen={isSettingsOpen}
        onClose={() => setIsSettingsOpen(false)}
        onSave={handleSaveSettings}
        initialTimeline={mockMatchTimeline}
      />
    </>
  );
});

export default MobileView;
