# Development Dockerfile with hot reloading
FROM node:22-slim

# Install pnpm globally and required system dependencies for Prisma
RUN npm install -g pnpm && \
    apt-get update && \
    apt-get install -y openssl && \
    rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /live-sports-event-dashboard

# Copy package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/backend/package.json ./apps/backend/
COPY packages/eslint-config/package.json ./packages/eslint-config/
COPY packages/shared-types/package.json ./packages/shared-types/

# Install ALL dependencies (including dev dependencies)
RUN pnpm install --frozen-lockfile

# Copy source code
COPY apps/backend/src ./apps/backend/src
COPY apps/backend/tsconfig.json ./apps/backend/
COPY apps/backend/prisma ./apps/backend/prisma
COPY packages/eslint-config ./packages/eslint-config
COPY packages/shared-types ./packages/shared-types
COPY tsconfig.base.json ./

# Copy .env file if it exists (create a default one if not)
COPY .env* ./

# Generate Prisma client
RUN pnpm --filter backend db:generate

# Note: Running as root for development to avoid permission issues
# In production, you should create a non-root user

# Expose port
EXPOSE 3001

# Set environment variables for development
ENV NODE_ENV=development
ENV PORT=3001

# Start the application with nodemon for hot reloading
WORKDIR /live-sports-event-dashboard/apps/backend
CMD ["npm", "run", "dev"]
